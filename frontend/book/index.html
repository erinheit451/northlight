<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Priority Queue - Northlight</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
/* ===========================
    NORTHLIGHT – Design System v1
   =========================== */
:root{
  --gray-50:#f8fafc; --gray-100:#f1f5f9; --gray-200:#e2e8f0; --gray-300:#cbd5e1;
  --gray-400:#94a3b8; --gray-500:#64748b; --gray-700:#334155; --gray-900:#0f172a;
  --primary-50:#eff6ff; --primary-500:#3b82f6; --primary-600:#2563eb; --primary-700:#1d4ed8;
  --red-50: #fef2f2; --red-100: #fee2e2; --red-500: #ef4444; --red-600: #dc2626; --red-700: #b91c1c; --red-800: #991b1b;
  --orange-50: #fff7ed; --orange-100: #ffedd5; --orange-500: #f97316; --orange-600: #ea580c;
  --green-100: #dcfce7; --green-700: #15803d;
  --text-xs:12px; --text-sm:14px; --text-base:16px; --text-lg:18px;
  --text-xl:20px; --text-2xl:24px; --text-3xl:30px;
  --space-1:4px; --space-2:8px; --space-3:12px; --space-4:16px; --space-5:20px;
  --space-6:24px; --space-8:32px; --space-12:48px;
  --radius-sm:6px; --radius-md:8px; --radius-lg:12px; --radius-xl:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  line-height:1.5; color:var(--gray-900); background:var(--gray-50);
  margin:0; padding: 0;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
main {max-width:1400px; margin: 0 auto; padding: var(--space-8);}
h1,h2,h3{margin:0; font-weight:700}
p {margin: 0 0 var(--space-4)}
.subtext{color:var(--gray-500); font-size:var(--text-sm)}

header.header{padding:16px 40px; border-bottom:1px solid var(--gray-200); background:rgba(255,255,255,.9);
  backdrop-filter:blur(10px); box-shadow:0 2px 8px rgba(0,0,0,.08); position:sticky; top:0; z-index:10;}
.header-content{display:flex; justify-content:space-between; align-items:center; max-width:1400px; margin:0 auto;}
.brand-section{display:flex; flex-direction:column;}
.brand-name{display:flex; align-items:baseline; margin-bottom:2px}
.company-name{font-family:'Montserrat',sans-serif; font-weight:800; font-size:28px; color:#2d3748; letter-spacing:1px}
.beta-label{font-weight:500; font-size:12px; color:#f6ad55; margin-left:4px; vertical-align:super}
.tagline{font-weight:400; font-size:14px; color:#718096; margin-top:0; font-family:'Inter',system-ui}
.nav-tabs{display:flex; gap:var(--space-2)}
.nav-tab{padding:var(--space-2) var(--space-4); border-radius:var(--radius-md); font-size:var(--text-sm); font-weight:600; text-decoration:none; color:var(--gray-700); border:1px solid var(--gray-200); background:#fff; cursor:pointer;}
.nav-tab:hover{background:var(--gray-50)}
.nav-tab.active{background:var(--primary-500); color:#fff; border-color:var(--primary-500)}

.summary-grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:var(--space-6); margin:var(--space-6) 0}
.summary-card{background:#fff; border:1px solid var(--gray-200); border-radius:var(--radius-lg); padding:var(--space-5); text-align:center;}
.summary-card.critical{border-left:4px solid var(--red-500)}
.summary-card.high{border-left:4px solid var(--orange-500)}
.summary-number{font-size:var(--text-3xl); font-weight:700; margin-bottom:var(--space-2)}
.summary-number.critical{color:var(--red-600)}
.summary-number.high{color:var(--orange-600)}
.summary-label{font-size:var(--text-sm); color:var(--gray-500); font-weight:500}

.filter-bar{background:#fff; border:1px solid var(--gray-200); border-radius:var(--radius-lg); padding:var(--space-4); margin:var(--space-6) 0; display:flex; gap:var(--space-4); align-items:center; flex-wrap:wrap;}
.filter-group{display:flex; flex-direction:column; gap:var(--space-2)}
.filter-label{font-size:var(--text-xs); color:var(--gray-500); font-weight:600; text-transform:uppercase; letter-spacing:0.5px;}
.filter-select{border:1px solid var(--gray-300); border-radius:var(--radius-md); padding:var(--space-2) var(--space-3); font-size:var(--text-sm); background:#fff; min-width:180px;}

.content-card{background:#fff; border:1px solid var(--gray-200); border-radius:var(--radius-lg); padding:var(--space-6); margin:var(--space-6) 0;}

.account-table{width:100%; border-collapse:collapse; background:#fff; border-radius:var(--radius-lg); overflow:hidden;}
.account-table th{background:var(--gray-100); padding:var(--space-3) var(--space-4); text-align:left; font-weight:600; font-size:var(--text-sm); color:var(--gray-600); border-bottom:2px solid var(--gray-200)}
.account-table td{padding:var(--space-4); border-bottom:1px solid var(--gray-100); font-size:var(--text-sm); vertical-align:middle;}
.account-table tbody tr:hover{background:var(--gray-50)}
.cell-content {display: flex; flex-direction: column; gap: 2px;}
.cell-main {font-weight: 600; color: var(--gray-900);}
.cell-subtext {font-size: var(--text-xs); color: var(--gray-500);}

.priority-badge {display: inline-block; padding: 2px 10px; border-radius: 999px; font-size: 11px; font-weight: 700; letter-spacing: 0.5px;}
.priority-badge.p1 {background: var(--red-100); color: var(--red-700);}
.priority-badge.p2 {background: var(--orange-100); color: var(--orange-600);}
.priority-badge.p3 {background: var(--gray-200); color: var(--gray-700);}
.priority-badge.p4 {background: var(--gray-100); color: var(--gray-500);}

/* --- NEW METRICS STYLES --- */
.metrics-list { margin: 0; padding: 0; list-style: none; display: flex; flex-direction: column; gap: var(--space-1); }
.metric-item { display: flex; justify-content: space-between; font-size: var(--text-xs); }
.metric-label { color: var(--gray-500); }
.metric-value { font-weight: 600; }
.metric-critical-strong { color: var(--red-800); }
.metric-critical { color: var(--red-600); }
.metric-warning { color: var(--orange-600); }
.metric-good { color: var(--green-700); }
.metric-neutral { color: var(--gray-700); }

.action-button {
  padding: 6px 14px; border-radius: var(--radius-md); font-size: var(--text-sm);
  font-weight: 600; border: 1px solid var(--gray-300); background: #fff;
  color: var(--gray-700); cursor: pointer; transition: all 0.2s;
}
.action-button:hover { background: var(--gray-100); border-color: var(--gray-400); }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="brand-section">
                <div class="brand-name"><span class="company-name">NORTHLIGHT</span><span class="beta-label">beta</span></div>
                <p class="tagline">Turn data into daylight</p>
            </div>
            <nav class="nav-tabs">
                <a href="/" class="nav-tab">Benchmark MVP</a>
                <a href="/book" class="nav-tab active">Account Priority</a>
            </nav>
        </div>
    </header>

    <main>
        <div style="margin-bottom: var(--space-8);">
            <h1 style="font-size: 36px;">Account Priority Queue</h1>
            <p class="subtext">Accounts are scored and prioritized based on retention risk and business value.</p>
        </div>

        <div class="summary-grid">
            <div class="summary-card">
                <div class="summary-number" id="totalAccounts">—</div>
                <div class="summary-label">Scored Accounts</div>
            </div>
            <div class="summary-card critical">
                <div class="summary-number critical" id="p1Critical">—</div>
                <div class="summary-label">P1 Critical</div>
            </div>
            <div class="summary-card high">
                <div class="summary-number high" id="p2High">—</div>
                <div class="summary-label">P2 High Priority</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" id="budgetAtRisk">—</div>
                <div class="summary-label">Budget at Risk (P1/P2)</div>
            </div>
        </div>

        <div class="filter-bar">
             <div class="filter-group">
                <div class="filter-label">View</div>
                <select id="viewFilter" class="filter-select">
                    <option value="optimizer">Optimizer View</option>
                </select>
            </div>
            <div class="filter-group">
                <div class="filter-label">Optimizer</div>
                <select id="optimizerFilter" class="filter-select"><option value="">All Optimizers</option></select>
            </div>
            <div class="filter-group">
                <div class="filter-label">Account Manager</div>
                <select id="amFilter" class="filter-select"><option value="">All AMs</option></select>
            </div>
             <div class="filter-group">
                <div class="filter-label">Partner</div>
                <select id="partnerFilter" class="filter-select"><option value="">All Partners</option></select>
            </div>
        </div>

        <div class="content-card">
            <table class="account-table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Account</th>
                        <th style="width: 15%;">Owner</th>
                        <th style="width: 15%;">Priority</th>
                        <th style="width: 25%;">Key Metrics</th>
                        <th style="width: 10%;">Budget</th>
                        <th style="width: 10%;">Actions</th>
                    </tr>
                </thead>
                <tbody id="accountTableBody">
                    <tr><td colspan="6" style="text-align:center; padding: 48px;">Loading accounts...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const API_BASES = [
        window.location.origin,
        'https://northlight-wsgw.onrender.com',
        'https://northlight-api-dev.onrender.com'
    ];

    const elements = {
        totalAccounts: document.getElementById('totalAccounts'),
        p1Critical: document.getElementById('p1Critical'),
        p2High: document.getElementById('p2High'),
        budgetAtRisk: document.getElementById('budgetAtRisk'),
        viewFilter: document.getElementById('viewFilter'),
        optimizerFilter: document.getElementById('optimizerFilter'),
        partnerFilter: document.getElementById('partnerFilter'),
        amFilter: document.getElementById('amFilter'),
        tableBody: document.getElementById('accountTableBody'),
    };

    const fmtMoney0 = x => (x == null || isNaN(x)) ? '—' : '$' + Math.round(x).toLocaleString('en-US');
    const fmtScore  = x => (x == null || isNaN(x)) ? '—' : Number(x).toFixed(1);

    // --- PRE-FLIGHT AND METRICS RENDERING FUNCTIONS ---

    function renderMetrics(c) {
        // This function will contain the existing metrics list logic
        const cplMetric = formatCpl(c.running_cid_cpl, c.effective_cpl_goal);
        const leadsMetric = formatLeads(c.lead_risk_reason, c.running_cid_leads);
        const productMetric = formatProductCount(c.advertiser_product_count);
        const pacingMetric = formatPacing(c.utilization);
        const ageMetric = formatAge(c.io_cycle);
        // ... add any other metric formatters here as we build them ...

        return `
            <ul class="metrics-list">
                <li class="metric-item"><span class="metric-label">Lead Performance</span><span class="metric-value ${leadsMetric.className}">${leadsMetric.text}</span></li>
                <li class="metric-item"><span class="metric-label">Pacing</span><span class="metric-value ${pacingMetric.className}">${pacingMetric.text}</span></li>
                <li class="metric-item"><span class="metric-label">CPL vs Goal</span><span class="metric-value ${cplMetric.className}">${cplMetric.text}</span></li>
                <li class="metric-item"><span class="metric-label">Product Mix</span><span class="metric-value ${productMetric.className}">${productMetric.text}</span></li>
                <li class="metric-item">
                    <span class="metric-label">Age</span>
                    <span class="metric-value ${ageMetric.className}">${ageMetric.text}</span>
                </li>
            </ul>
        `;
    }

    function renderChecklist(c) {
        // This function builds the HTML for the new Pre-Flight Checklist
        const goalStatus = c.is_cpl_goal_missing 
            ? `<span class="metric-value metric-warning">Pending</span>`
            : `<span class="metric-value metric-good">Set</span>`;

        return `
            <ul class="metrics-list">
                <li class="metric-item"><span class="metric-label">Status</span><span class="metric-value metric-neutral">Pending Launch</span></li>
                <li class="metric-item"><span class="metric-label">CPL Goal</span>${goalStatus}</li>
                <li class="metric-item"><span class="metric-label">Spend Activity</span><span class="metric-value metric-neutral">No Spend</span></li>
            </ul>
        `;
    }

    // --- NEW METRIC FORMATTING HELPERS ---
    
    function formatCpl(actualCpl, goalCpl) {
        if (actualCpl == null || goalCpl == null || goalCpl === 0) {
            return { text: 'No Goal', className: 'metric-neutral' };
        }
        const pct = ((actualCpl / goalCpl) - 1) * 100;
        if (pct > 0) {
            const className = pct >= 100 ? 'metric-critical-strong' : (pct >= 50 ? 'metric-critical' : 'metric-warning');
            return { text: `${pct.toFixed(0)}% over`, className };
        } else {
            return { text: `${Math.abs(pct).toFixed(0)}% under`, className: 'metric-good' };
        }
    }

    function formatPacing(utilization) {
        if (utilization == null) {
            return { text: '—', className: 'metric-neutral' };
        }
        const deviation = (utilization - 1) * 100;
        
        if (deviation < -50) return { text: `${Math.abs(deviation).toFixed(0)}% under`, className: 'metric-critical' };
        if (deviation < -25) return { text: `${Math.abs(deviation).toFixed(0)}% under`, className: 'metric-warning' };
        if (deviation > 25)  return { text: `${deviation.toFixed(0)}% over`, className: 'metric-warning' };
        
        return { text: 'On Pace', className: 'metric-good' };
    }

    function formatLeads(reason, leads) {
        if (leads == null) {
            return { text: '—', className: 'metric-neutral' };
        }

        switch (reason) {
            case 'Hyper Critical':
                return { text: 'Zero Leads (Behind Pace)', className: 'metric-critical-strong' };
            case 'Critical Underperformance':
                return { text: `Critically Low (${leads})`, className: 'metric-critical' };
            case 'Concerning Underperformance':
                return { text: `Low Volume (${leads})`, className: 'metric-warning' };
            case 'Healthy':
            default:
                return { text: `Healthy (${leads})`, className: 'metric-good' };
        }
    }

    function formatAge(months) {
        if (months == null) return { text: '—', className: 'metric-neutral' };
        if (months <= 1) return { text: 'Brand New', className: 'metric-warning' };
        if (months <= 3) return { text: 'First 90 Days', className: 'metric-warning' };
        if (months <= 12) return { text: 'First Year', className: 'metric-neutral' };
        return { text: 'Established', className: 'metric-good' };
    }

    function formatProductCount(count) {
        if (count == null) return { text: '—', className: 'metric-neutral' };
        const className = count === 1 ? 'metric-warning' : 'metric-good';
        return { text: `${count} products`, className };
    }

    // --- API & RENDERING LOGIC ---

    async function fetchFromAny(path, params = {}) {
        const qs = new URLSearchParams(params).toString();
        for (const base of API_BASES) {
            try {
                const response = await fetch(`${base}${path}?${qs}`);
                if (!response.ok) throw new Error(`${response.status}`);
                return await response.json();
            } catch (e) {
                console.warn(`API base ${base} failed:`, e.message);
            }
        }
        throw new Error('All API bases failed');
    }

    async function fetchData(params = {}) {
        const [summary, accounts] = await Promise.all([
            fetchFromAny('/api/book/summary', params),
            fetchFromAny('/api/book/all', params)
        ]);
        return { summary, accounts };
    }

    function renderSummary(summary) {
        const counts = summary.counts || {};
        elements.totalAccounts.textContent = counts.total_accounts ?? '0';
        elements.p1Critical.textContent    = counts.p1_critical ?? '0';
        elements.p2High.textContent        = counts.p2_high ?? '0';
        elements.budgetAtRisk.textContent  = fmtMoney0(summary.budget_at_risk ?? 0);
    }

    function populateFilters(facets) {
        const populate = (select, options, label) => {
            const currentVal = select.value;
            select.innerHTML = `<option value="">All ${label}</option>`;
            (options || []).forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
            });
            select.value = currentVal;
        };
        populate(elements.optimizerFilter, facets?.optimizers, 'Optimizers');
        populate(elements.partnerFilter,   facets?.partners,   'Partners');
        populate(elements.amFilter,         facets?.ams,        'AMs');
    }

    function renderTable(accounts) {
        if (!accounts || accounts.length === 0) {
            elements.tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 48px;">No accounts match the selected filters.</td></tr>`;
            return;
        }

        const rows = accounts.map(acc => {
            const tierClass = (acc.priority_tier || 'P4').split(' ')[0].toLowerCase();
            const cplMetric = formatCpl(acc.running_cid_cpl, acc.effective_cpl_goal);
            const pacingMetric = formatPacing(acc.utilization);
            const leadsMetric = formatLeads(acc.lead_risk_reason, acc.running_cid_leads);
            const ageMetric = formatAge(acc.io_cycle);

            return `
                <tr>
                    <td>
                        <div class="cell-content">
                            <div class="cell-main">${acc.advertiser_name || 'N/A'}</div>
                            <div class="cell-subtext" style="font-weight: 500;">${acc.campaign_name || 'No Name'}</div>
                            <div class="cell-subtext">Partner: ${acc.bid_name || 'N/A'}</div>
                            <div class="cell-subtext">CID: ${acc.campaign_id || 'N/A'}</div>
                        </div>
                    </td>
                    <td>
                        <div class="cell-content">
                            <div class="cell-main">${acc.optimizer || '—'}</div>
                            <div class="cell-subtext">${acc.am || 'No AM'}</div>
                        </div>
                    </td>
                    <td>
                        <div class="cell-content">
                            <div class="cell-main">${fmtScore(acc.final_priority_score)}</div>
                            <div><span class="priority-badge ${tierClass}">${acc.priority_tier}</span></div>
                        </div>
                    </td>
                    <td>
                        ${acc.primary_issue === 'Pre-Flight Check'
                            ? renderChecklist(acc)
                            : renderMetrics(acc)
                        }
                    </td>
                    <td>${fmtMoney0(acc.campaign_budget)}</td>
                    <td>
                        <button class="action-button" data-maid="${acc.maid}">Diagnose</button>
                    </td>
                </tr>
            `;
        }).join('');

        elements.tableBody.innerHTML = rows;
    }

    async function handleFilterChange() {
        const params = {
            view: elements.viewFilter.value,
            optimizer: elements.optimizerFilter.value || undefined,
            partner: elements.partnerFilter.value   || undefined,
            am: elements.amFilter.value             || undefined,
        };
        elements.tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 48px;">Loading...</td></tr>`;
        try {
            const { summary, accounts } = await fetchData(params);
            renderSummary(summary);
            renderTable(accounts);
        } catch(err) {
            console.error('Failed to fetch data on filter change:', err);
            elements.tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 48px; color: var(--red-600);">Error loading data. Could not connect to API.</td></tr>`;
        }
    }

    async function init() {
        try {
            const initialParams = { view: elements.viewFilter.value };
            const { summary, accounts } = await fetchData(initialParams);
            renderSummary(summary);
            populateFilters(summary.facets || {});
            renderTable(accounts);
            [elements.viewFilter, elements.optimizerFilter, elements.partnerFilter, elements.amFilter]
                .forEach(el => el.addEventListener('change', handleFilterChange));
        } catch (err) {
            console.error('Failed to initialize page:', err);
            elements.tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 48px; color: var(--red-600);">Error loading data. Could not connect to API. Check console/network.</td></tr>`;
        }
    }

    init();
});
</script>

</body>
</html>