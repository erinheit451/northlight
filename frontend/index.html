<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Northlight – Benchmark MVP</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;800&display=swap" rel="stylesheet">
```html
<style>
  /* ===========================
     NORTHLIGHT – Complete Styles
     (includes spacing + padding fixes)
     =========================== */

  /* ---- Tokens & base elements ---- */
  :root {
    --fg:#111;
    --muted:#666;
    --line:#e5e5e5;
    --ok:#ffb020;
    --good:#2ea043;
    --bad:#d93f0b;
  }
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    margin: 24px;
    max-width: 960px;
    color: var(--fg);
  }
  h1 { margin: 0 0 12px; }
  h3 { margin: 0 0 8px; }
  .card { border: 1px solid var(--line); border-radius: 10px; padding: 16px; margin: 12px 0; }
  label { display:block; margin: 8px 0 6px; font-weight: 600; }
  input, select { width: 100%; padding: 8px; border:1px solid var(--line); border-radius:8px; }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
  button { padding: 10px 14px; border-radius: 8px; border: 1px solid #333; cursor: pointer; background:#fff; }
  .small { color:var(--muted); font-size:12px; }
  .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); margin-right:6px; }
  .pill.good { background:#ecfdf3; border-color:#bbf7d0; color:#065f46; }
  .pill.ok   { background:#fffbeb; border-color:#fde68a; color:#92400e; }
  .pill.bad  { background:#fef2f2; border-color:#fecaca; color:#991b1b; }

  /* ---- Verdict-First Benchmark Design ---- */
  .benchmark-verdict {
    margin: 16px 0 24px; padding: 16px; border-radius: 12px; background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #e5e7eb;
  }
  .benchmark-verdict.outside-target { border-left-color: #ef4444; }
  .benchmark-verdict.on-target      { border-left-color: #22c55e; }
  .benchmark-verdict.exceeds-target { border-left-color: #2563eb; }

  .primary-value { font-size: 28px; font-weight: 700; color: var(--fg); margin-top: 8px; }
  .verdict-context { margin-bottom: 16px; display: flex; flex-wrap: wrap; gap: 16px; align-items: center; }
  .delta-text { font-size: 14px; color: var(--muted); }
  .delta-text.negative { color: #059669; }
  .delta-text.positive { color: #dc2626; }
  .peer-context { font-size: 13px; color: var(--muted); background: #f8fafc; padding: 4px 8px; border-radius: 6px; }

  /* ---- Spotlight Marker Bar ---- */
  .bar-container { padding-top: 28px; margin-bottom: 8px; }
  .bar-scale { position: relative; height: 16px; margin-bottom: 4px; }
  .scale-point { position: absolute; transform: translateX(-50%); font-size: 11px; font-weight: 600; color: var(--muted); }
  .bar-scale .scale-point:first-child { left: 0; transform: translateX(6px); }
  .bar-scale .scale-point:last-child  { left: 100%; transform: translateX(calc(-100% - 6px)); }

  .bar-track { position: relative; height: 20px; border-radius: 10px; display: flex; overflow: visible; border: 1px solid #e5e7eb; }
  .zone-bg { height: 100%; }
  .zone-bg.excellent, .zone-bg.needs-improvement { background-color: #f3f4f6; }
  .zone-bg.target-range { background-color: #dcfce7; }

  .user-marker {
    position: absolute; top: 50%; width: 24px; height: 24px;
    border-radius: 50%; border: 3px solid white;
    transform: translate(-50%, -50%); box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    z-index: 3; transition: left 0.8s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s;
  }
  .user-marker.excellent         { background-color: #2563eb; }
  .user-marker.target-range      { background-color: #22c55e; }
  .user-marker.needs-improvement { background-color: #ef4444; }

  .user-label {
    position: absolute; top: -36px; left: 50%; transform: translateX(-50%);
    font-size: 11px; font-weight: 700; color: #111; background: white; padding: 4px 8px; border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1); white-space: nowrap; z-index: 5; text-align: center; pointer-events: none;
  }
  .user-label .label-title { font-size: 9px; font-weight: 500; color: var(--muted); display: block; }

  .bar-labels { display: flex; margin-top: 10px; font-size: 10px; font-weight: 500; }
  .bar-labels .label { text-align: center; color: var(--muted); transition: all 0.3s ease; flex-shrink: 0; }
  .bar-labels .label.active { font-weight: 700; }
  .bar-labels .label.active.excellent         { color: #2563eb; }
  .bar-labels .label.active.target-range      { color: #166534; }
  .bar-labels .label.active.needs-improvement { color: #ef4444; }

  /* ---- Responsive tweaks for verdict blocks ---- */
  @media (max-width: 768px) {
    .primary-value { font-size: 20px; }
    .verdict-context { flex-direction: column; align-items: flex-start; gap: 8px; }
    .bar-container { padding-top: 32px; }
  }

  /* ---- Goal CPL Block ---- */
  .primary-status-block {
    border: 1px solid var(--line); border-left: 4px solid #e5e7eb;
    border-radius: 12px; padding: 16px; margin: 16px 0; background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  .primary-status-block.outside-target { border-left-color: #ef4444; }
  .primary-status-block.on-target      { border-left-color: #22c55e; }
  .primary-status-block.scenario-aggressive,
  .primary-status-block.scenario-good,
  .primary-status-block.scenario-conservative { background: #fff; }

  .status-header { font-size: 20px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
  .status-header.on-target      { color: var(--fg); }
  .status-header.outside-target { color: #dc2626; }
  .status-header.exceeds-target { color: #3730a3; }
  .status-header.good           { color: var(--good); }
  .status-header.bad            { color: var(--bad); }
  .status-header.ok             { color: var(--ok); }

  .goal-comparison { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 12px 0; padding: 0; border: none; background: transparent; }
  .goal-item { display:flex; flex-direction:column; gap:2px; }
  .goal-k { font-size:12px; color:var(--muted); }
  .goal-v { font-size:16px; font-weight:600; color: var(--fg); }
  .goal-value.crossed-out { text-decoration: none; opacity: 1; }

  .recommendation-chip {
    display:inline-block; padding:6px 10px; border-radius:8px;
    background:#ecfdf3; border:1px solid #bbf7d0; color:#065f46; font-weight:600; margin-top: 8px;
  }
  .context-text { color: var(--muted); font-size: 14px; margin: 8px 0; }

  /* ---- Diagnosis Card ---- */
  .diagnosis-card { padding: 20px; border: 2px solid var(--line); border-radius: 12px; margin: 24px 0; }
  .diagnosis-card .status-header { margin-bottom: 8px; }
  .diagnosis-card p { margin: 4px 0 12px; font-size: 14px; line-height: 1.5; }
  .diagnosis-card ul { margin: 12px 0 12px 20px; padding: 0; font-size: 13px; }
  .diagnosis-card li { margin-bottom: 6px; }
  .diag-kicker { font-size: 12px; color: var(--muted); font-style: italic; margin-top: 16px; }

  /* ---- Scenario Builder ---- */
  .scenario-builder-input-grid { grid-template-columns: 1fr; gap: 12px; }
  @media (min-width: 768px) { .scenario-builder-input-grid { grid-template-columns: 1fr 1fr 1fr; } }
  .scenario-builder-input-grid > div { background: #f8fafc; padding: 12px 16px; border: 1px solid var(--line); border-radius: 10px; }
  .scenario-builder-input-grid .label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }

  .numeric-input-wrapper { position: relative; }
  .numeric-input-wrapper .numeric-input { background-color: #fff; width: 90px; }
  .numeric-input-wrapper::before {
    content: attr(data-symbol); position: absolute; top: 50%; transform: translateY(-50%);
    left: 10px; color: var(--muted); font-size: 14px;
  }
  .numeric-input-wrapper.symbol-after::before { left: auto; right: 10px; }
  .numeric-input-wrapper.symbol-before .numeric-input { padding-left: 24px; }
  .numeric-input-wrapper.symbol-after  .numeric-input { padding-right: 24px; }

  input[type="range"] {
    -webkit-appearance: none; appearance: none; width: 100%; height: 8px;
    background: #e5e7eb; border-radius: 4px; outline: none; --track-color: #3b82f6;
    background-image: linear-gradient(var(--track-color), var(--track-color));
    background-size: var(--progress, 0%) 100%; background-repeat: no-repeat;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%;
    background: var(--track-color); border: 3px solid white; box-shadow: 0 1px 4px rgba(0,0,0,0.2); cursor: pointer; margin-top: -6px;
  }
  input[type="range"]::-moz-range-thumb {
    width: 20px; height: 20px; border-radius: 50%; background: var(--track-color);
    border: 3px solid white; box-shadow: 0 1px 4px rgba(0,0,0,0.2); cursor: pointer;
  }
  .slider-labels { display: flex; justify-content: space-between; font-size: 11px; color: var(--muted); margin-top: 4px; }

  /* ===========================
     NL UI Styles (Form & CTA)
     Includes spacing & right-edge fixes
     =========================== */

  /* Scope a border-box model to the tool to prevent input overflow eating gaps */
  .tool-section { padding: 60px 40px; max-width: 1200px; margin: 0 auto; box-sizing: border-box; }
  .tool-section *, .tool-section *::before, .tool-section *::after { box-sizing: inherit; }

  .tool-title {
    font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 36px;
    color: #2d3748; margin-bottom: 48px; text-align: center;
  }
  .form-container {
    background: #fff; border-radius: 16px; padding: 48px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #f1f5f9;
    max-width: 800px; margin: 0 auto;
  }

  /* Grids: use minmax(0,1fr) + min-width:0 so children can shrink and gaps remain visible */
  .form-grid,
  .input-grid {
    display: grid;
    grid-template-columns: minmax(0,1fr) minmax(0,1fr);
    gap: 32px;
  }
  .form-grid { margin-bottom: 40px; }
  .input-grid { margin-bottom: 48px; }
  .form-group { display: flex; flex-direction: column; min-width: 0; }

  /* Ensure inputs/selects stay inside their columns (fixes right-edge padding visual) */
  .tool-section .form-input,
  .tool-section .form-select,
  .tool-section input,
  .tool-section select {
    box-sizing: border-box;
    width: 100%;
  }

  .form-label {
    font-family: 'Montserrat', sans-serif; font-weight: 600; font-size: 14px;
    color: #374151; margin-bottom: 12px;
  }
  .form-select, .form-input {
    padding: 16px 20px; border: 2px solid #e5e7eb; border-radius: 12px;
    font-family: 'Montserrat', sans-serif; font-size: 16px; background: white; color: #374151;
    transition: border-color .2s ease, box-shadow .2s ease; min-height: 44px;
  }
  .form-select:focus, .form-input:focus {
    outline: none; border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(96,165,250,0.10);
  }

  .button-container { display: flex; justify-content: center; }
  .run-button {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: #fff; border: none;
    padding: 12px 28px; border-radius: 10px; font-family: 'Montserrat', sans-serif;
    font-weight: 600; font-size: 16px; cursor: pointer;
    transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
    box-shadow: 0 4px 14px rgba(59,130,246,.25);
  }
  .run-button:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(59,130,246,.35); }
  .run-button:active { transform: translateY(0); }
  .run-button:focus-visible { outline: 3px solid rgba(59,130,246,.35); outline-offset: 2px; border-radius: 12px; }

  /* Align results width with form container */
  #results { max-width: 800px; margin: 24px auto; }

  /* Mobile collapse */
  @media (max-width: 768px) {
    .tool-section { padding: 40px 20px; }
    .form-container { padding: 32px 24px; margin: 0 16px; }
    .form-grid, .input-grid { grid-template-columns: 1fr; gap: 24px; }
    .tool-title { font-size: 28px; margin-bottom: 32px; }
  }

  /* ===========================
     Header (feedback link removed)
     =========================== */
  header.header, header.header * { box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
  .header {
    padding: 16px 40px; border-bottom: 1px solid #e2e8f0; background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); position: relative;
  }
  .header::after {
    content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 1px;
    background: linear-gradient(90deg, transparent 0%, #cbd5e0 50%, transparent 100%);
  }
  .header-content { display: grid; grid-template-columns: 1fr 1fr; max-width: 1200px; margin: 0 auto; gap: 20px; }
  .brand-section { display: flex; flex-direction: column; justify-self: start; }
  .brand-name { display: flex; align-items: baseline; margin-bottom: 2px; }
  .company-name { font-weight: 800; font-size: 28px; color: #2d3748; letter-spacing: 1px; }
  .beta-label { font-weight: 500; font-size: 12px; color: #f6ad55; margin-left: 4px; vertical-align: super; }
  .tagline { font-weight: 400; font-size: 14px; color: #718096; margin-top: 0; }

  .right-section { display: flex; flex-direction: column; justify-self: end; align-items: flex-end; gap: 8px; }
  .beta-row { display: flex; align-items: center; gap: 8px; }
  .beta-badge {
    display: flex; align-items: center; gap: 6px; background: linear-gradient(135deg, #ebf8ff, #dbeafe);
    border: 1px solid #60a5fa; padding: 6px 12px; border-radius: 16px;
    font-weight: 600; font-size: 12px; color: #1e40af; box-shadow: 0 2px 4px rgba(96, 165, 250, 0.15);
  }
  .beta-subtitle { font-weight: 400; font-size: 11px; color: #64748b; margin-top: 2px; }

  /* Remove any lingering feedback link elements if present */
  .feedback-row, .feedback-link { display: none !important; }

  @media (max-width: 768px) {
    .header { padding: 16px 20px; }
    .header-content { grid-template-columns: 1fr; gap: 8px; }
    .right-section { align-items: flex-start; text-align: left; }
    .company-name { font-size: 24px; }
  }
</style>

<!-- NL_HEADER_STYLES_END -->
</head>
<body>
<!-- NL_HEADER_START -->
<header class="header">
  <div class="header-content">
    <div class="brand-section">
      <div class="brand-name">
        <span class="company-name">NORTHLIGHT</span>
        <span class="beta-label">beta</span>
      </div>
      <div class="tagline">Turn data into daylight</div>
    </div>
    <div class="right-section">
      <div class="beta-row">
        <div class="beta-badge">
          <span>🧪</span>
          <span>Beta Access</span>
        </div>
      </div>
      <div class="beta-subtitle">Free while we perfect things</div>
    </div>
  </div>
</header>
<!-- NL_HEADER_END -->

<main class="tool-section">
  <h1 class="tool-title">Benchmark Your Campaign</h1>

  <div class="form-container">
    <div class="form-grid">
      <div class="form-group">
        <label for="category" class="form-label">Category</label>
        <select id="category" class="form-select"></select>
      </div>
      <div class="form-group">
        <label for="subcategory" class="form-label">Subcategory</label>
        <select id="subcategory" class="form-select"></select>
      </div>
    </div>

    <div class="form-grid">
      <div class="form-group">
        <label for="goal_cpl" class="form-label">Goal CPL</label>
        <input id="goal_cpl" type="number" step="0.01" class="form-input" />
      </div>
      <div class="form-group">
        <label for="budget" class="form-label">Budget</label>
        <input id="budget" type="number" step="0.01" class="form-input" />
      </div>
      <div class="form-group">
        <label for="clicks" class="form-label">Clicks</label>
        <input id="clicks" type="number" step="1" class="form-input" />
      </div>
      <div class="form-group">
        <label for="leads" class="form-label">Leads</label>
        <input id="leads" type="number" step="1" class="form-input" />
      </div>
    </div>

    <div class="button-container">
      <button id="runBtn" class="run-button">Run Benchmark</button>
    </div>
  </div>
</main>


  <div id="results" class="card" style="display:none;">
    <h3>Results</h3>
    <div id="primaryStatusBlock"></div>
    <div id="cpl-verdict-container"></div>
    <div id="cpc-verdict-container"></div>
    <div id="cr-verdict-container"></div>
    
    <div id="diagnosisCard"></div>

    <div id="scenarioBuilder" class="card" style="display:none; margin-top:24px;"></div>
  </div>

<script>
const PROD_API = 'https://northlight-wsgw.onrender.com';
const DEV_API  = 'https://northlight-api-dev.onrender.com';
const host = window.location.hostname;

// This logic correctly identifies localhost, develop, and PR preview URLs as "development"
const isDev = host.includes('localhost') || host.includes('127.0.0.1') || host.includes('develop') || host.includes('pr-');
const API = isDev ? DEV_API : PROD_API;
console.log(`API endpoint set to: ${API}`);
let lastPayload = null;

// ---------- UI helpers ----------
function fmtPct1(v) { return (v == null) ? "—" : (v*100).toFixed(1) + "%"; }
function fmtMoney(v){ return (v == null) ? "—" : "$" + Number(v).toFixed(2); }
function pill(text, cls) { return `<span class="pill ${cls}">${text}</span>`; }

// ---------- Data handling helpers ----------
function ensureTargetRange(metricData, unit, metricName) {
  if (metricData?.target_range?.low != null && metricData?.target_range?.high != null) {
    return metricData.target_range;
  }
  const m = metricData?.median ?? metricData?.value ?? (unit === '%' ? 0.05 : (metricName === 'CPC' ? 3 : 50));
  const p25 = metricData?.p25, p75 = metricData?.p75;
  if (p25 != null && p75 != null) return { low: Math.max(0, p25), high: Math.max(p75, p25) };
  const span = Math.max(0.00001, m * 0.15); // ±15%
  return { low: Math.max(0, m - span), high: m + span };
}

function deriveVerdict(value, targetRange, direction) {
  if (value == null || targetRange?.low == null || targetRange?.high == null) return 'unknown';
  const { low, high } = targetRange;
  if (value >= low && value <= high) return 'on_target';
  if (direction === 'lower-is-better') {
    return (value < low) ? 'exceeds_target' : 'outside_target';
  } else {
    return (value > high) ? 'exceeds_target' : 'outside_target';
  }
}

function deltaPctFromRange(value, targetRange) {
  const { low, high } = targetRange;
  if (value < low) return ((low - value) / Math.max(low, 1e-9)) * 100;
  if (value > high) return ((value - high) / Math.max(high, 1e-9)) * 100;
  return 0;
}

function roundUpToNiceCurrency(x) {
  const targets = [0.5, 1, 2, 3, 5, 7.5, 10, 12, 15, 20, 25, 30, 40, 50, 60, 75, 100, 150, 200, 250, 300, 400, 500, 750, 1000];
  const want = x * 1.15;
  for (const t of targets) if (want <= t) return t;
  return Math.ceil(want / 100) * 100;
}

function roundUpToNicePercent(x) {
  const targets = [0.05, 0.08, 0.10, 0.12, 0.15, 0.18, 0.20, 0.25, 0.30, 0.40, 0.50, 0.60, 0.80, 1.00];
  const want = x * 1.15;
  for (const t of targets) if (want <= t) return t;
  return Math.min(1.00, Math.ceil(want * 20) / 20);
}


// ---------- Component Rendering ----------
function renderVerdictBenchmark(containerEl, metricData, metricName, metricUnit, direction, opts = {}) {
  const { hidePeer = false } = opts;
  const value = metricData?.value;

  if (value == null) {
    containerEl.innerHTML = `<div class="benchmark-verdict" style="padding: 12px;">No data for ${metricName}</div>`;
    return;
  }

  const target_range = ensureTargetRange(metricData, metricUnit === '%' ? '%' : '$', metricName);
  const localVerdict = deriveVerdict(value, target_range, direction);
  const rawDelta = (typeof metricData?.delta_from_target === 'number') ? Math.abs(metricData.delta_from_target) : deltaPctFromRange(value, target_range);
  const median = metricData?.median;
  const peer_multiple = metricData?.peer_multiple;

  const verdictLabels = { "outside_target": "Outside Target", "on_target": "On Target", "exceeds_target": "Excellent", "unknown": "Benchmark" };
  const verdictIcons  = { "outside_target": "⚠️", "on_target": "🎯", "exceeds_target": "🎉", "unknown": "📊" };

  const valueFormatter = metricUnit === '$' ? fmtMoney : fmtPct1;
  const primaryValue   = valueFormatter(value);
  const verdictClass   = (localVerdict || "").replace(/_/g, "-");

  let deltaText = "";
  if (target_range) {
    const below = value < target_range.low;
    const above = value > target_range.high;
    if (below || above) {
      const isGood = (direction === 'lower-is-better' && below) || (direction === 'higher-is-better' && above);
      const deltaClass = isGood ? 'negative' : 'positive';
      const rangeText = `(${valueFormatter(target_range.low)}–${valueFormatter(target_range.high)})`;
      const deltaDescription = below ? "below target range" : "above target range";
      deltaText = `<span class="delta-text ${deltaClass}">${Math.round(Math.abs(rawDelta))}% ${deltaDescription} ${rangeText}</span>`;
    } else {
      deltaText = `<span class="delta-text">within target range (${valueFormatter(target_range.low)}–${valueFormatter(target_range.high)})</span>`;
    }
  }

  const peerText = (!hidePeer && peer_multiple && median) ? `<span class="peer-context">${peer_multiple.toFixed(1)}× peer median</span>` : "";
  const barData = calculateBarData(value, target_range, median, direction, metricUnit, metricName);

  containerEl.innerHTML = `
    <div class="benchmark-verdict ${verdictClass}">
      <div class="status-header ${verdictClass}">
        ${verdictIcons[localVerdict] || "📊"} ${verdictLabels[localVerdict] || "Benchmark"}
      </div>
      <div class="primary-value">Your ${metricName} is ${primaryValue}</div>
      ${(deltaText || peerText) ? `<div class="verdict-context">${deltaText} ${peerText}</div>` : ''}
      <div class="bar-container">${generateBar(barData)}</div>
    </div>`;
}

function calculateBarData(userValue, targetRange, median, direction, metricUnit, metricName) {
  if (!targetRange || targetRange.low == null || targetRange.high == null) {
    targetRange = ensureTargetRange({ value: userValue, median }, metricUnit, metricName);
  }

  const baseTop = Math.max( userValue ?? 0, targetRange.high ?? 0, median ?? 0 );
  let minScale = 0, maxScale;
  if (metricUnit === '%') {
    maxScale = roundUpToNicePercent(baseTop);
  } else {
    if (metricName === 'CPC') {
      maxScale = roundUpToNiceCurrency(baseTop);
    } else {
      maxScale = Math.max(baseTop * 1.4, targetRange.high * 1.6, (median || 0) * 1.5);
      maxScale = roundUpToNiceCurrency(maxScale);
    }
  }

  const totalRange = maxScale - minScale;
  if (totalRange <= 0) return null;

  let userSection = 'target-range';
  if (userValue < targetRange.low) {
    userSection = (direction === 'lower-is-better') ? 'excellent' : 'needs-improvement';
  } else if (userValue > targetRange.high) {
    userSection = (direction === 'lower-is-better') ? 'needs-improvement' : 'excellent';
  }

  const valueFormatter = metricUnit === '$' ? fmtMoney : fmtPct1;
  const clamp01 = v => Math.max(0, Math.min(1, v));
  const userPosition = clamp01((userValue - minScale) / totalRange) * 100;

  let excellentWidth = clamp01((targetRange.low - minScale) / totalRange) * 100;
  let targetWidth    = clamp01((targetRange.high - targetRange.low) / totalRange) * 100;
  let improvementWidth = Math.max(0, 100 - excellentWidth - targetWidth);

  const sum = excellentWidth + targetWidth + improvementWidth;
  if (sum !== 100 && sum > 0) {
    excellentWidth = (excellentWidth / sum) * 100;
    targetWidth = (targetWidth / sum) * 100;
    improvementWidth = (improvementWidth / sum) * 100;
  }

  const sectionWidths = (direction === 'lower-is-better')
    ? { 'excellent': excellentWidth, 'target-range': targetWidth, 'needs-improvement': improvementWidth }
    : { 'needs-improvement': excellentWidth, 'target-range': targetWidth, 'excellent': improvementWidth };

  const scalePoints = [
    { value: minScale }, { value: targetRange.low },
    { value: targetRange.high }, { value: maxScale }
  ].map(p => ({
    label: valueFormatter(p.value),
    position: clamp01((p.value - minScale) / totalRange) * 100
  }));

  return { userValue, userPosition, userSection, sectionWidths, scalePoints, valueFormatter, direction, metricName };
}

function generateBar(data) {
  if (!data) return '';
  const scaleHtml = data.scalePoints.map(p => `<div class="scale-point" style="left: ${p.position}%;">${p.label}</div>`).join('');
  const sections = (data.direction === 'lower-is-better')
    ? ['excellent', 'target-range', 'needs-improvement']
    : ['needs-improvement', 'target-range', 'excellent'];

  return `
    <div class="bar-scale">${scaleHtml}</div>
    <div class="bar-track">
      ${sections.map(key => `<div class="zone-bg ${key}" style="flex-basis: ${(data.sectionWidths[key] || 0)}%"></div>`).join('')}
      <div class="user-marker ${data.userSection}" style="left: ${data.userPosition}%; ">
        <div class="user-label">
          <span class="label-title">Your ${data.metricName}</span>
          ${data.valueFormatter(data.userValue)}
        </div>
      </div>
    </div>
    <div class="bar-labels">
      ${sections.map(key => {
        const labelText = key.replace(/-/g, ' ');
        return `<div class="label ${key} ${data.userSection === key ? 'active' : ''}" style="text-transform: capitalize; flex-basis: ${(data.sectionWidths[key] || 0)}%">${labelText}</div>`;
      }).join('')}
    </div>
  `;
}

function renderPrimaryStatusBlock(d) {
  const container = document.getElementById("primaryStatusBlock");
  const ga = d.goal_analysis || {};
  const userGoal = d.input?.goal_cpl;

  container.className = "primary-status-block";
  if (!userGoal) {
    container.innerHTML = '<div class="context-text">Enter a goal CPL to see analysis.</div>';
    return;
  }

  const range = (ga.realistic_range && ga.realistic_range.low != null && ga.realistic_range.high != null)
    ? ga.realistic_range
    : ensureTargetRange({ value: userGoal, median: d?.benchmarks?.cpl?.median }, '$', 'CPL');

  const { low, high } = range;
  const recommended = ga.recommended_cpl ?? null;
  let verdictClass = 'on-target';
  if (ga.goal_scenario === 'goal_too_aggressive') verdictClass = 'outside-target';
  if (ga.goal_scenario === 'goal_in_range')      verdictClass = 'on-target';
  if (ga.goal_scenario === 'goal_conservative')  verdictClass = 'on-target';

  let deltaHtml = '';
  if (userGoal < low || userGoal > high) {
    const pct = Math.round(deltaPctFromRange(userGoal, range));
    const below = userGoal < low;
    const deltaClass = 'positive';
    const desc = below ? "below typical range" : "above typical range";
    deltaHtml = `<span class="delta-text ${deltaClass}">${pct}% ${desc} (${fmtMoney(low)}–${fmtMoney(high)})</span>`;
  } else {
    deltaHtml = `<span class="delta-text">within typical range (${fmtMoney(low)}–${fmtMoney(high)})</span>`;
  }

  const titleIcon = (verdictClass === 'outside-target') ? '⚠️' : '🎯';
  const titleText = 'Goal CPL check';
  const conservativeNote = (ga.goal_scenario === 'goal_conservative') ? `<span class="pill ok">Conservative goal</span>` : '';
  const recChip = recommended ? `<div class="recommendation-chip">Suggested target: ${fmtMoney(recommended)}</div>` : '';

  container.classList.add(verdictClass);
  container.innerHTML = `
    <div class="status-header ${verdictClass}">${titleIcon} ${titleText}</div>
    <div class="primary-value">Goal CPL: ${fmtMoney(userGoal)}</div>
    <div class="verdict-context">${deltaHtml} ${conservativeNote}</div>
    <div class="goal-comparison">
      <div class="goal-item">
        <div class="goal-k">Your goal</div>
        <div class="goal-v">${fmtMoney(userGoal)}</div>
      </div>
      <div class="goal-item">
        <div class="goal-k">Typical</div>
        <div class="goal-v">${fmtMoney(low)} – ${fmtMoney(high)}</div>
      </div>
      <div class="goal-item">
        <div class="goal-k">Recommended</div>
        <div class="goal-v">${recommended ? fmtMoney(recommended) : '—'}</div>
      </div>
    </div>
    ${recChip}
  `;
}

function statusFromBench(metric, metricName, unit, direction) {
  if (!metric || metric.value == null) return 'UNKNOWN';
  const tr = ensureTargetRange(metric, unit, metricName);
  const verdict = deriveVerdict(metric.value, tr, direction);
  if (verdict === 'on_target' || verdict === 'exceeds_target') return 'GOOD';
  const delta = deltaPctFromRange(metric.value, tr);
  return (delta <= 15) ? 'AVG' : 'WEAK';
}

// Helper function to generate the diagnosis card HTML
function createDiagnosisCard(status, title, message, listItems = [], kicker = '', provisionalInfo = '') {
  const listHtml = listItems.length ? `<ul>${listItems.map(item => `<li>${item}</li>`).join('')}</ul>` : '';
  return `
    <div class="card diagnosis-card">
      ${provisionalInfo}
      <div class="status-header ${status}">${title}</div>
      <p>${message}</p>
      ${listHtml}
      ${kicker}
    </div>
  `;
}

function renderDiagnosis(d) {
    const el = document.getElementById("diagnosisCard");
    const { input, goal_analysis: ga, benchmarks: bm, targets, overall } = d;
    const status = overall?.goal_status;

    // --- Pre-checks (Guardrails) ---
    if ((input.clicks || 0) === 0) {
        el.innerHTML = createDiagnosisCard('bad', '🛑 No Traffic', 'There are no clicks recorded for this period. Expand coverage or bids before optimizing.', ['Broaden match types/targets; check ad eligibility and daily budgets.']);
        return;
    }

    const crSuspicious = (() => {
        const v = bm.cr?.value;
        if (v == null) return false;
        const tr = ensureTargetRange(bm.cr, '%', 'CR');
        return v > Math.max(tr.high * 1.8, 0.15);
    })();

    if ((input.leads === 0 && (input.clicks || 0) >= 100) || crSuspicious) {
        el.innerHTML = createDiagnosisCard('bad', '🚨 Verify Tracking',
            (input.leads === 0) ? 'Clicks but zero conversions. Likely tracking failure.' : 'Suspiciously high CR. You may be counting non-lead events.',
            ['Fire a test conversion; verify thank-you tag/pixel.', 'Confirm you’re counting qualified leads only.']
        );
        return;
    }
    
    if (input.budget != null && input.budget < 500) {
        el.innerHTML = createDiagnosisCard('bad', '💰 Budget Too Low', 'Under $500 isn’t enough signal. Increase budget or <strong>Run Grader</strong> to find the right budget.');
        return;
    }

    let softBudgetBanner = (input.budget != null && input.budget < 1000)
      ? `<div class="pill ok" style="margin-bottom:8px;">Budget constrained ($${input.budget}) — insights are provisional</div>`
      : '';
    const provisional = ((input.leads || 0) < 15 || (input.clicks || 0) < 300);
    const provisionalTag = provisional ? '<div class="pill ok" style="margin-bottom:8px;">Provisional – low data volume</div>' : softBudgetBanner;
    
    // --- Main Diagnosis Logic ---
    const cplStatus = statusFromBench(bm.cpl, 'CPL', '$', 'lower-is-better');
    const cpcStatus = statusFromBench(bm.cpc, 'CPC', '$', 'lower-is-better');
    const crStatus  = statusFromBench(bm.cr,  'CR',  '%', 'higher-is-better');
    const goalScenario = ga.goal_scenario;
    const performanceIsGood = cplStatus !== 'WEAK' && cpcStatus !== 'WEAK' && crStatus !== 'WEAK';

    if (performanceIsGood) {
        if (status === 'achieved' || status === 'on_track') {
            el.innerHTML = createDiagnosisCard('good', '🚀 Ready to Scale',
                `CPL is meeting or beating the goal. ${goalScenario === 'goal_conservative' ? 'Your goal is conservative — you can scale with confidence.' : 'Performance is solid.'}`,
                ['Increase budget (start +30–50%).', 'Add adjacent ad groups / geos.'], '', provisionalTag
            );
        } else { // Performance is good, but goal is still missed -> Expectations problem.
            const rec = ga.recommended_cpl;
            const rng = ga.realistic_range;
            el.innerHTML = createDiagnosisCard('ok', '🎯 Realign Goal Expectations',
                `Your performance is good, but your goal is outside the typical range. A more realistic target is <strong>${fmtMoney(rec)}</strong> (Typical: ${fmtMoney(rng?.low)}–${fmtMoney(rng?.high)}).`,
                ['<strong>Primary Action:</strong> Use this benchmark data to reset the CPL goal with your client.', '<strong>Next Step:</strong> Run a deeper ROAS calculation to find the true breakeven CPL.'], '', provisionalTag
            );
        }
        return;
    }

    if (status === 'behind') {
        const needCr = targets.target_cr ?? ((bm.cpc?.value && input?.goal_cpl) ? (bm.cpc.value / input.goal_cpl) : null);
        const needCpc = targets.target_cpc ?? ((input?.goal_cpl != null && bm.cr?.value != null) ? input.goal_cpl * bm.cr.value : null);
        const kicker = (goalScenario === 'goal_too_aggressive') ? `<div class="diag-kicker">*Note: Your CPL goal is also aggressive for this market. Re-evaluate it after improving performance.</div>` : '';
        
        const trCPC = ensureTargetRange(bm.cpc, '$', 'CPC');
        const trCR  = ensureTargetRange(bm.cr,  '%', 'CR');
        const cpcExtreme = bm.cpc?.value > trCPC.high * 1.5;
        const crDeep     = bm.cr?.value  < trCR.low  * 0.5;

        if (crStatus === 'WEAK' && cpcStatus !== 'WEAK') { // CR is the clear bottleneck
            el.innerHTML = createDiagnosisCard('bad', '🔧 Fix Conversion Rate',
                `Your CR of ${fmtPct1(bm.cr?.value)} is the main bottleneck. You need ~<strong>${needCr != null ? fmtPct1(Math.max(0, needCr)) : '—'}</strong> to hit your CPL goal.`,
                ['Audit page speed & mobile experience (aim &lt;2.5s LCP).', 'Ensure message match: ad → headline; CTA above fold.'], kicker, provisionalTag
            );
        } else if (cpcStatus === 'WEAK' && crStatus !== 'WEAK') { // CPC is the clear bottleneck
            el.innerHTML = createDiagnosisCard('bad', '💰 Reduce Traffic Cost',
                `Your pages convert well, but the CPC of ${fmtMoney(bm.cpc?.value)} is too high. You need ~<strong>${needCpc != null ? fmtMoney(Math.max(0, needCpc)) : '—'}</strong> to hit your goal.`,
                ['Add negatives; cut waste by geo/device/daypart.', 'Tighten match types; refresh RSAs.'], kicker, provisionalTag
            );
        } else { // Both are weak, use tie-breaker
            if (cpcExtreme && !crDeep) { // CPC is extremely bad, CR is not as bad
                el.innerHTML = createDiagnosisCard('bad', '🔥 Start with CPC, then CR',
                    'Both levers need work, but your CPC is an extreme outlier. Start by fixing traffic cost.',
                    ['Aggressively prune queries and tighten targeting to control CPCs.', 'Once CPC is in a healthier range, shift focus to landing page optimization.'], kicker, provisionalTag
                );
            } else { // Default to CR first
                el.innerHTML = createDiagnosisCard('bad', '🔥 Start with CR, then CPC',
                    'Both levers need work. Start with CR for faster lift, then address CPC.',
                    ['Apply LP quick wins; verify tracking quality.', 'Then prune queries / restructure bids.'], kicker, provisionalTag
                );
            }
        }
        return;
    }

    el.innerHTML = createDiagnosisCard('', '📊 Monitor Performance', 'Your campaign is performing within average ranges. Continue to test incremental CR and CPC improvements to increase efficiency.', [], '', provisionalTag);
}

function renderScenarioBuilder(d) {
  const el = document.getElementById('scenarioBuilder');
  const bm = d.benchmarks || {};
  const goal = d.input?.goal_cpl ?? null;

  const hasCPC = bm.cpc && (bm.cpc.value != null || bm.cpc.median != null);
  const hasCR  = bm.cr  && (bm.cr.value  != null || bm.cr.median  != null);
  if (!hasCPC || !hasCR) {
    el.style.display = 'none';
    return;
  }

  let state = {
    budget: d.input?.budget ?? 5000,
    cpc:    bm.cpc?.value ?? bm.cpc?.median ?? 3.00,
    cr:     bm.cr?.value  ?? bm.cr?.median  ?? 0.04
  };
  const current = { ...state };
  
  const p25cpc = bm.cpc?.p25, p75cpc = bm.cpc?.p75;
  const p25cr  = bm.cr?.p25,  p75cr  = bm.cr?.p75;

  const bounds = {
    budgetMin: 0,
    budgetMax: Math.max((d.input?.budget ?? 5000) * 2, 10000),
    cpcMin: Math.max(0.2, (p25cpc ?? state.cpc) * 0.5),
    cpcMax: (p75cpc ?? state.cpc) * 1.8 || 20,
    crMin: Math.max(0.001, (p25cr ?? state.cr) * 0.3),
    crMax: Math.min(1.0, (p75cr ?? state.cr) * 2.0)
  };
  if (bounds.cpcMin >= bounds.cpcMax) { bounds.cpcMin = Math.max(0.2, state.cpc * 0.5); bounds.cpcMax = state.cpc * 2.0; }
  if (bounds.crMin  >= bounds.crMax)  { bounds.crMin  = Math.max(0.001, state.cr  * 0.5); bounds.crMax  = Math.min(1.0, state.cr  * 2.0); }

  const clamp = (v, min, max) => Math.min(Math.max(v, min), max);

  const compute = () => {
    const clicks = (state.budget > 0 && state.cpc > 0) ? state.budget / state.cpc : 0;
    const leads  = (state.cr > 0 && state.cpc > 0) ? state.budget * state.cr / state.cpc : 0;
    const cpl    = (state.cr > 0) ? state.cpc / state.cr : null;
    return { clicks, leads, cpl };
  }

  // --- Event Handling (attached once) ---
  const updateState = (key, rawValue, isFromNumeric) => {
    let num = parseFloat(rawValue);
    if (!isFinite(num)) return;
    if (key === 'cr' && isFromNumeric) num /= 100; // numeric CR input is in %
    state[key] = clamp(num, bounds[`${key}Min`], bounds[`${key}Max`]);
    render();
  };

  el.oninput = (e) => {
    const keyMap = { sb_budget: 'budget', sb_cpc: 'cpc', sb_cr: 'cr' };
    if (keyMap[e.target.id]) updateState(keyMap[e.target.id], e.target.value, false);
  };
  
  el.onchange = (e) => {
    const keyMap = { sb_budget_n: 'budget', sb_cpc_n: 'cpc', sb_cr_n: 'cr' };
    if (keyMap[e.target.id]) updateState(keyMap[e.target.id], e.target.value, true);
  };

  el.onclick = (e) => {
    if (e.target.id === 'sb_reset') {
        state = { ...current };
        render();
    }
    if (goal && e.target.id === 'sb_snap_cr' && goal > 0 && state.cpc > 0) {
        state.cr = clamp(state.cpc / goal, bounds.crMin, bounds.crMax);
        render();
    }
    if (goal && e.target.id === 'sb_snap_cpc' && goal > 0 && state.cr > 0) {
        state.cpc = clamp(goal * state.cr, bounds.cpcMin, bounds.cpcMax);
        render();
    }
  };

  function render() {
    const { clicks, leads, cpl } = compute();
    const banners = [];
    if (clicks < 300 || leads < 15) banners.push(`<span class="pill ok" style="margin-bottom:8px;">Provisional – low volume</span>`);
    if (state.budget >= 500 && state.budget < 1000) banners.push(`<span class="pill ok" style="margin-bottom:8px;">Budget constrained (${fmtMoney(state.budget)})</span>`);

    // Calculate progress for slider tracks
    const budgetProgress = (state.budget - bounds.budgetMin) / (bounds.budgetMax - bounds.budgetMin) * 100;
    const cpcProgress = (state.cpc - bounds.cpcMin) / (bounds.cpcMax - bounds.cpcMin) * 100;
    const crProgress = (state.cr - bounds.crMin) / (bounds.crMax - bounds.crMin) * 100;

    el.style.display = 'block';
    el.innerHTML = `
      <h3 style="margin:0 0 12px;">Scenario Builder</h3>
      ${banners.join(' ')}
      <div class="scenario-builder-input-grid" style="margin-top:8px;">
        <div>
          <div class="label-row">
            <label>Budget</label>
            <div class="numeric-input-wrapper symbol-before" data-symbol="$">
              <input type="number" id="sb_budget_n" class="numeric-input" value="${Math.round(state.budget)}" />
            </div>
          </div>
          <input type="range" id="sb_budget" min="${bounds.budgetMin}" max="${bounds.budgetMax}" step="50" value="${state.budget}" style="--progress: ${budgetProgress}%">
          <div class="slider-labels">
            <span>${fmtMoney(bounds.budgetMin)}</span>
            <span>${fmtMoney(bounds.budgetMax)}</span>
          </div>
        </div>
        <div>
          <div class="label-row">
            <label>CPC</label>
            <div class="numeric-input-wrapper symbol-before" data-symbol="$">
              <input type="number" id="sb_cpc_n" step="0.01" class="numeric-input" value="${state.cpc.toFixed(2)}" />
            </div>
          </div>
          <input type="range" id="sb_cpc" min="${bounds.cpcMin.toFixed(2)}" max="${bounds.cpcMax.toFixed(2)}" step="0.01" value="${state.cpc}" style="--progress: ${cpcProgress}%">
          <div class="slider-labels">
            <span>${fmtMoney(bounds.cpcMin)}</span>
            <span>${fmtMoney(bounds.cpcMax)}</span>
          </div>
        </div>
        <div>
          <div class="label-row">
            <label>CR</label>
            <div class="numeric-input-wrapper symbol-after" data-symbol="%">
              <input type="number" id="sb_cr_n" step="0.1" class="numeric-input" value="${(state.cr * 100).toFixed(1)}" />
            </div>
          </div>
          <input type="range" id="sb_cr" min="${bounds.crMin.toFixed(3)}" max="${bounds.crMax.toFixed(3)}" step="0.001" value="${state.cr}" style="--progress: ${crProgress}%">
          <div class="slider-labels">
            <span>${fmtPct1(bounds.crMin)}</span>
            <span>${fmtPct1(bounds.crMax)}</span>
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:20px;">
        <div class="card">
          <div class="small">Leads</div>
          <div class="primary-value" style="margin-top:4px;">${Math.round(leads)}</div>
          <div class="small">Clicks: ${Math.round(clicks)}</div>
        </div>
        <div class="card">
          <div class="small">CPL ${goal && cpl != null && cpl > goal ? `(Goal: ${fmtMoney(goal)})` : ''}</div>
          <div class="primary-value" style="margin-top:4px; color:${(goal && cpl != null && cpl <= goal) ? 'var(--good)' : 'var(--fg)'}">${cpl != null ? fmtMoney(cpl) : '—'}</div>
          <div class="small">Formula: CPC ÷ CR</div>
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
        ${goal ? `<button id="sb_snap_cr" class="small">Solve for Goal via CR</button>
                 <button id="sb_snap_cpc" class="small">Solve for Goal via CPC</button>` : ''}
        <button id="sb_reset" class="small">Reset to Current</button>
      </div>
    `;
  }
  render(); // Initial render
}

// ---------- Main Execution ----------
async function fetchMeta() {
  const catSel = document.getElementById("category");
  const subSel = document.getElementById("subcategory");
  try {
    const res = await fetch(`${API}/benchmarks/meta`);
    if (!res.ok) {
        // This provides a clear error in the console if the API call fails
        throw new Error(`API request failed with status: ${res.status}`);
    }
    const meta = await res.json();
    if (!Array.isArray(meta) || meta.length === 0) {
        throw new Error("API returned empty or invalid category data.");
    }
    const cats = [...new Set(meta.map(x => x.category))].sort();
    catSel.innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join("");

    function buildSubcats(cat) {
        const subs = meta.filter(x => x.category === cat).map(x => x.subcategory).sort();
        subSel.innerHTML = subs.map(s => `<option value="${s}">${s}</option>`).join("");
    }
    buildSubcats(catSel.value);
    catSel.addEventListener("change", e => buildSubcats(e.target.value));
  } catch (err) {
    // This will log the error and update the UI to show that the data failed to load
    console.error("Could not load benchmark categories:", err);
    catSel.innerHTML = `<option disabled selected>Error: Data unavailable</option>`;
    subSel.innerHTML = `<option disabled selected>-</option>`;
  }
}

async function runDiag() {
  const payload = {
    category: document.getElementById("category").value,
    subcategory: document.getElementById("subcategory").value,
    budget: parseFloat(document.getElementById("budget").value) || null,
    clicks: parseFloat(document.getElementById("clicks").value) || null,
    leads: parseFloat(document.getElementById("leads").value) || null,
    goal_cpl: document.getElementById("goal_cpl").value ? parseFloat(document.getElementById("goal_cpl").value) : null
  };
  lastPayload = payload;

  const res = await fetch(`${API}/diagnose`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  if (!res.ok) { alert(`Error ${res.status}: ${await res.text()}`); return; }
  renderResults(await res.json());
}

function renderResults(d) {
  document.getElementById("results").style.display = "block";
  const bm = d.benchmarks || {};

  const metricsToRender = [
    { id: "cpl-verdict-container", data: bm.cpl, name: "CPL", unit: "$", dir: 'lower-is-better' },
    { id: "cpc-verdict-container", data: bm.cpc, name: "CPC", unit: "$", dir: 'lower-is-better' },
    { id: "cr-verdict-container",  data: bm.cr,  name: "CR",  unit: "%", dir: 'higher-is-better' }
  ];

  metricsToRender.forEach(metric => {
    renderVerdictBenchmark(
      document.getElementById(metric.id),
      metric.data, metric.name, metric.unit, metric.dir, { hidePeer: true }
    );
  });
  
  renderPrimaryStatusBlock(d);
  renderDiagnosis(d);
  renderScenarioBuilder(d);
}

document.getElementById("runBtn").addEventListener("click", runDiag);
fetchMeta();
</script>
</body>
</html>